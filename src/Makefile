CC = gcc

CCOPT    = -O3 -flto -fopenmp -ffast-math -fno-finite-math-only -march=native
CCDEBUG  = -DNDEBUG
CCDEF    =
CCWARN   = -Wall -Wextra
XCFLAGS  = 
XLDFLAGS = 

MODEL_LANG    ?= R SimoC Lua
LUAPATH       ?= $(abspath lua)
LUAJIT_CFLAGS ?= $(shell pkg-config --cflags luajit)
LUAJIT_LIB    ?= $(shell pkg-config --libs luajit)
R_CFLAGS      ?= $(shell pkg-config --cflags libR)
R_LIB         ?= $(shell pkg-config --libs-only-l --libs-only-L libR)
LIBFFI_CFLAGS ?= $(shell pkg-config --cflags libffi)
LIBFFI_LIB    ?= $(shell pkg-config --libs libffi)

export

# You probably don't want to configure anything below this line

################################################################################

M2_EXECUTABLE = m2
M2_CDEF       = lua/m2_cdef.lua
LUA_EXPORTS   = lua_exports.h
M2_LIBS       = $(LUAJIT_LIB)

M2_O = main.o bitmap.o fhk_graph.o fhk_solve.o fhk_aux.o type.o arena.o sim.o sim_ds.o grid.o vec.o\
	   gmap.o vmath.o

M2_C = $(M2_O:.o=.c)

MODEL_O = model/aux.o
MODEL_C = $(MODEL_O:.o=.c)

ifneq (,$(findstring Lua,$(MODEL_LANG)))
	MODEL_O += model/model_Lua.o
endif

ifneq (,$(findstring R,$(MODEL_LANG)))
	MODEL_O += model/model_R.o
	M2_LIBS += $(R_LIB)
endif

ifneq (,$(findstring SimoC,$(MODEL_LANG)))
	MODEL_O += model/model_SimoC.o
	M2_LIBS += $(LIBFFI_LIB) -ldl
endif

################################################################################

XCFLAGS += -DM2_LUAPATH='"$(LUAPATH)"'
CFLAGS = $(LUAJIT_CFLAGS) $(CCOPT) $(CCDEBUG) $(CCDEF) $(CCWARN) $(XCFLAGS)

# -rdynamic is needed to access C symbols of the executable from lua
LDFLAGS = -rdynamic $(M2_LIBS) $(CCOPT) $(CCDEBUG) $(XLDFLAGS)

################################################################################

default: $(M2_EXECUTABLE) $(M2_CDEF)

valgrind: CCOPT = -g3 -O3 -march=x86-64 -fopenmp -flto -ffast-math
valgrind: default

debug: CCOPT = -g3 -fopenmp
debug: CCDEBUG = -DDEBUG
debug: default

ubsan: CC = clang
ubsan: CCOPT = -g3 -O3 -march=native -fopenmp -flto -ffast-math -fsanitize=undefined -fsanitize=address
ubsan: CCWARN += -Wno-c++17-extensions -Wno-gnu-alignof-expression
ubsan: CCDEBUG = -DDEBUG
ubsan: default

dep:
	$(CC) $(CCOPT) $(CCDEBUG) $(CCDEF) $(XCFLAGS) -MM $(M2_C) > Makefile.dep
	$(CC) $(CCOPT) $(CCDEBUG) $(CCDEF) $(XCFLAGS) -MM model/*.c\
		| sed 's/^\([^ ]\)/model\/\1/'\
		>> Makefile.dep
	$(CC) $(CCOPT) $(CCDEBUG) $(CCDEF) $(XCFLAGS) -MM -MT $(M2_CDEF) $(LUA_EXPORTS) >> Makefile.dep

# XXX: this is a turbo hacky way to do it
# for whatever reason this is really fragile, it breaks if
#     * -g3 is set
#     * any -I option is given
ffi $(M2_CDEF): $(LUA_EXPORTS)
	echo "-- Autogenerated file - don't touch" > $(M2_CDEF)
	echo "local ffi = require 'ffi'" >> $(M2_CDEF)
	echo "ffi.cdef [[" >> $(M2_CDEF)
	$(CC) $(CCDEF) $(CCDEBUG) -P -E -nostdinc -DEXPORT_LUA_CDEF $(LUA_EXPORTS) 2>/dev/null\
		| sed -r 's/@@remove@@\s*(;?)//'\
		>> $(M2_CDEF)\
		| true
	echo "]]" >> $(M2_CDEF)

clean:
	$(RM) $(M2_EXECUTABLE) $(M2_CDEF) *.o model/*.o

.PHONY: default valgrind debug ubsan dep ffi clean

################################################################################

include Makefile.dep

%.o: %.c
	$(CC) $(CFLAGS) -c $< -o $@

$(M2_EXECUTABLE): $(M2_O) $(MODEL_O)
	$(CC) $(LDFLAGS) $^ -o $@

model/model_R.o: model/model_R.c
	$(CC) $(CFLAGS) $(R_CFLAGS) -c $< -o $@

model/model_SimoC.o: model/model_SimoC.c
	$(CC) $(CFLAGS) $(LIBFFI_CFLAGS) -c $< -o $@

model/model_Lua.o: model/model_Lua.c
	$(CC) $(CFLAGS) -c $< -o $@
